---
title: "data_analysis"
author: "Chenyu Li"
format: html
editor: source
editor_options: 
  chunk_output_type: console
---

# 1 Initial setting

## 1.1 clear workspacce and set default color

```{r reset, include=FALSE}
graphics.off()
rm(list=ls(all.names=TRUE))
options(digits = 3)

options(ggplot2.discrete.colour= c("#ff7700","#2F7FC1"))
options(ggplot2.discrete.fill= c("#ff7700","#2F7FC1"))
```

## 1.2 Packages, theme setting and path

```{r primary setting, include=FALSE}

# package list
packages = c("tidyverse", "brms","ggpubr", "smartr","tidybayes","emmeans","bayestestR")
# get the package names that are not installed
missing_packages <- setdiff(packages, rownames(installed.packages()))
# install the missing packages
if (length(missing_packages) > 0) install.packages(missing_packages)
# library package
suppressMessages(sapply(packages, library, character.only = TRUE))


# import private functions (do not print the output)
nothing <- sapply(list.files("./functions", pattern = "*.R", full.names = TRUE), source)

# theme
theme_set(theme_bw())
dodge1 = position_dodge(.1)
dodge2 = position_dodge(.2)
dodge3 = position_dodge(.3)
dodge4 = position_dodge(.4)

theme_test <- theme(
  strip.text = element_text(size = 11, face = "bold"),
  strip.background = element_rect(fill = "#bababa"),
  axis.text = element_text(size = 10.5),
)

# task name
task <- "Exp1"
model_path <- str_glue("./models/Model-{task}/Models/")
sample_path <- str_glue("./models/Model-{task}/Sample/")
figure_path <- str_glue("./figures/figures-{task}/")
log_path <- "./models/"
bf_path = "./models/BayesFactor/"

# check whether the folders are existent or not. If not, create a new one
dir.create(file.path(model_path), showWarnings = FALSE)
dir.create(file.path(sample_path), showWarnings = FALSE)
dir.create(file.path(figure_path), showWarnings = FALSE)

```


# 2 Data processing

## 2.1 Import data

```{r}

# Import Response data
Raw_Res <- str_glue("./data/Data_{task}_Res.csv") %>% read_csv()

# Category and count response
Data_Res <- Raw_Res %>% 
  filter(screenID == "retrieval") %>% 
  mutate(
    participant = factor(participant),
    condition = factor(condition)) %>% 
  classifyRes(groupLevel = c("participant", "block", "trial"))

# Import Survey data
Data_Survey <- str_glue("./data/Data_{task}_Survey.csv") %>% read_csv()

```

## 2.2 Data cleaning

```{r}

excluding_list = Data_Survey %>% 
  filter(str_detect(attention,"是"), korean_question != "从未") %>% 
  pull(participant)

Data_Res <- Data_Res %>% 
  filter(!participant %in% excluding_list)

str_glue("{length(excluding_list)} participants are excluded from the analysis.") %>% message()

```

## 2.3 Create a table for the number of options

```{r}

# Create a table for the number of options
Table_nOptions <- data.frame(
  updPos = c("yes","no")) %>% 
  mutate(nCorrect = 1,
         nTransOld = ifelse(updPos=="yes" , 3, 2),
         nTransNew = case_when(
           updPos=="yes" ~ 2,
           updPos=="no" ~ 3),
         nOutSame = ifelse(updPos=="yes", 1, 1e-4),
         nOutOther = case_when(
           updPos=="yes" ~ 2, 
           updPos=="no" ~ 3),
         nNPL = 6)

# Re-frame the table
Columns_nOptions <- Table_nOptions %>% 
  pivot_longer(cols = starts_with("n"), names_to ="response", values_to = "nOpt") %>% 
  mutate(response = substring(response, 2))

# Save it for drawing the figure
write_csv(Columns_nOptions, str_glue("./figures/figures-Data/Data_{task}_nOptions.csv"))
```

# 3 Ploting data

## 3.1 Data and data transform

```{r}

Table_response <- Data_Res %>% 
  select(
    participant, condition, ends_with("New"), 
    ends_with("Old"), starts_with("Out"), NPL, NoRes) %>% 
  pivot_longer(
    cols = c(ends_with("New"), ends_with("Old"), starts_with("Out"),NPL, NoRes), 
    names_to = "response", values_to = "value") %>% 
  summarySE(DV = value, within = c("condition"), between = c("response"), group = "participant") %>% 
  mutate( 
    condition = factor(
      condition, 
      levels = c("cn","kr"), 
      labels = c("Familiar (Chinese)", "Unfamiliar (Korean)")),
    # correct error bar
    upper = ifelse(abs(mean) < 1e-5, 0, mean + ci),
    lower = ifelse(abs(mean) < 1e-5, 0, mean - ci)) %>% 
  select(!c(ci,se,n))

```


## 3.2 Plot (Accuracy)

```{r}
(
  Plot_Res_Correct <- Table_response %>% 
    filter(str_detect(response,"Correct")) %>%
    mutate(
      response = factor(
        response, 
        levels = c("CorrectOld","CorrectNew"), 
        labels = c("Origianl items","New items"))
    ) %>% 
    ggplot(aes(x = response, y = mean, color = condition, fill = condition))+
    geom_errorbar(
      aes(ymax = upper, ymin = lower),
      linewidth = 0.8,
      width = 0.1,
      position = dodge2)+
    geom_point(
      size = 3,
      shape = 23,
      color = "black",
      position = dodge2)+
    ylim(0,1)+
    labs(
      x = "Item type", 
      y = "Proportion of correct", 
      fill = "Condition",
      color = "Condition")+
    theme_test
)

ggsave(
  plot = Plot_Res_Correct,
  path = figure_path,
  filename = "Plot_Res_Correct.pdf",
  width = 6.5, height = 5
)

```


# Model fit

## Response

### Data and data arguments

```{r}

# Data -------------------------------------------------------------------------

mData_Res <- Data_Res %>% 
  pivot_longer(
    cols = c(CorrectNew, CorrectOld, TransNew, TransOld, OutSame, OutOther, NPL),
    names_to = "category",
    values_to = "value"
  ) %>%
  summarize(
    Resp = sum(value, na.rm = TRUE),
    nResp = sum(!is.na(value)),
    .by = c(participant, condition, category)
  ) %>% 
  mutate(
    itemType = case_when(
      str_detect(category, "Old") ~ "Original",
      str_detect(category, "New") ~ "New",
      str_detect(category, "Out") ~ "Outdated",
      TRUE ~ "NPL"),
    response = case_when(
      str_detect(category, "Correct|Same") ~ "correct",
      TRUE ~ "incorrect")
    )

contrasts(mData_Res$condition) = bayestestR::contr.equalprior(n = 2)

# Arguments --------------------------------------------------------------------

Args_response <- list(
  formula = Resp | trials(nResp) ~ 1 + condition*itemType + (1 + condition*itemType || participant),
  family = binomial(),
  prior = c(prior(normal(0,1), class = "b"), 
            prior(student_t(3, 0, 2), class = "sd", lb = 0)),
  chains = 8,
  iter = 10000,
  warmup = 2500,
  cores = 8,
  control = list(adapt_delta = 0.95, max_treedepth = 15),
  save_pars = save_pars(all = TRUE)
)

```

### Correct responses

```{r}

mData_Res_Correct <- mData_Res %>% 
  filter(response == "correct",itemType %in% c("Original","New")) %>% 
  mutate(itemType = factor(itemType))

contrasts(mData_Res_Correct$itemType) = bayestestR::contr.equalprior(n = 2)

smart_runFun(
  fun = brm,
  args = Args_response %>% append(list(
      data = mData_Res_Correct,
      file = str_glue("{model_path}Model_Exp1_Correct.rds"))),
  untilFinished = FALSE,
  name = "Model_Exp1_Correct",
)


Model_Correct <- readRDS(str_glue("{model_path}Model_Exp1_Correct.rds"))
smart_runFun(
  fun = unupdate,
  args = list(model = Model_Correct),
  untilFinished = TRUE,
  export = "Prior_Correct"
)
pairwise_comparisons(
  Model_Correct, 
  Prior_Correct, 
  c("~ condition","~ condition | itemType","~ itemType | condition"))



'
Parameter |       BF
--------------------
cn - kr   | 4.00e+14

Parameter        |       BF
---------------------------
cn - kr New      | 1.02e+08
cn - kr Original | 2.49e+18

Parameter         |       BF
----------------------------
New - Original cn |    0.515
New - Original kr | 2.74e+03
'


```


## Memory Measurement Model

## 4.1 Data and data transform

```{r}

mData_M3 <- Data_Res %>% 
  tidy_M3(
    responses = c("Correct", "TransOld", "TransNew", "OutSame", "OutOther", "NPL"),
    group = c("participant", "condition", "updPos"),
    DV_name = "y",
    nDV_name = "nRet",
    DV_numerical = TRUE
  ) %>% 
  left_join(Table_nOptions, by = "updPos") %>% 
  mutate(
    iP = ifelse(updPos == "yes", 1, 0),
  ) %>% 
  select(-updPos)

```


## 4.2 Function

```{r}

genM3Form <- function(choice_rule="softmax") {
  
  if (choice_rule=="softmax") {
    
    M3_formula <- bf(
      y | trials(nRet) ~ Correct + log(nCorrect),
      nlf(mu2 ~ TransOld + log(nTransOld)),
      nlf(mu3 ~ TransNew + log(nTransNew)),
      nlf(mu4 ~ OutSame + log(nOutSame)),
      nlf(mu5 ~ OutOther + log(nOutOther)),
      nlf(mu6 ~ NPL + log(nNPL)),
      nlf(Correct ~ (1-iP)*(a1 + c1) + iP*(a2 + c2) + b),
      nlf(TransOld ~ a1 + b),
      nlf(TransNew ~ a2 + b),
      nlf(OutSame ~ iP*(inv_logit(ra)*a1 + inv_logit(rc)*c1 + b) + (1-iP)*(-100)),
      nlf(OutOther ~ inv_logit(ra)*a1 + b),
      nlf(NPL ~ b),
      a1 ~ 0 + condition + (0 + condition || participant),
      c1 ~ 0 + condition + (0 + condition || participant),
      a2 ~ 0 + condition + (0 + condition || participant),
      c2 ~ 0 + condition + (0 + condition || participant),
      ra ~ 0 + condition + (0 + condition || participant),
      rc ~ 0 + condition + (0 + condition || participant),
      b ~ 1,
      nl = TRUE
    )
  } else {
    
    M3_formula <- bf(
      y | trials(nRet) ~ log(Correct*nCorrect),
      nlf(mu2 ~ log(TransOld*nTransOld)),
      nlf(mu3 ~ log(TransNew*nTransNew)),
      nlf(mu4 ~ log(OutSame*nOutSame)),
      nlf(mu5 ~ log(OutOther*nOutOther)),
      nlf(mu6 ~ log(NPL*nNPL)),
      nlf(Correct ~ (1-iP)*(exp(a1) + exp(c1)) + iP*(exp(a2) + exp(c2)) + b),
      nlf(TransOld ~ exp(a1) + b),
      nlf(TransNew ~ exp(a2) + b),
      nlf(OutSame ~ iP*(inv_logit(ra)*exp(a1) + inv_logit(rc)*exp(c1) + b) + exp(-100)),
      nlf(OutOther ~ inv_logit(ra)*exp(a1) + b),
      nlf(NPL ~ b),
      a1 ~ 0 + condition + (0 + condition || participant),
      c1 ~ 0 + condition + (0 + condition || participant),
      a2 ~ 0 + condition + (0 + condition || participant),
      c2 ~ 0 + condition + (0 + condition || participant),
      ra ~ 0 + condition + (0 + condition || participant),
      rc ~ 0 + condition + (0 + condition || participant),
      b ~ 1,
      nl = TRUE
    )
  }
  
  return (M3_formula)
}

genM3Prior <- function(choice_rule="softmax") {
  
  if (choice_rule=="softmax") {
    M3_prior <- c(
      prior(normal(3,1), class = "b", nlpar = "a1"),
      prior(normal(3,1), class = "b", nlpar = "c1"),
      prior(normal(3,1), class = "b", nlpar = "a2"),
      prior(normal(3,1), class = "b", nlpar = "c2"),
      prior(logistic(0,1), class = "b", nlpar = "ra"),
      prior(logistic(0,1), class = "b", nlpar = "rc"),
      prior(constant(0), class = "b", nlpar = "b")
      )
  } else {
    M3_prior <- c(
      prior(normal(1.5,0.5), class = "b", nlpar = "a1"), 
      prior(normal(1.5,0.5), class = "b", nlpar = "c1"),
      prior(normal(1.5,0.5), class = "b", nlpar = "a2"),
      prior(normal(1.5,0.5), class = "b", nlpar = "c2"),
      prior(normal(1.5,0.5), class = "b", nlpar = "ra"),
      prior(normal(1.5,0.5), class = "b", nlpar = "rc"),
      prior(constant(0.1), class = "b", nlpar = "b")
      )
  }
  
  return(M3_prior)
}

```


## 4.3 Model comparison

```{r}

# softmax

smart_runFun(
  fun = brm,
  args = list(
    formula = genM3Form(choice_rule = "softmax"),
    data = mData_M3,
    family = multinomial(refcat = NA),
    prior = genM3Prior(choice_rule = "softmax"),
    chains = 8,
    cores = 8,
    iter = 10000,
    warmup = 2500,
    control = list(adapt_delta = 0.95),
    save_pars = save_pars(all = TRUE),
    sample_prior = "yes",
    init = 0,
    file = paste0(model_path, "Model_Exp1_M3_Softmax")
    ),
  name = "Model_Exp1_M3_Softmax"
)


# luce choice rule

smart_runFun(
  fun = brm,
  args = list(
    formula = genM3Form(choice_rule = "luce"),
    data = mData_M3,
    family = multinomial(refcat = NA),
    prior = genM3Prior(choice_rule = "luce"),
    chains = 8,
    cores = 8,
    iter = 10000,
    warmup = 2500,
    control = list(adapt_delta = 0.95),
    save_pars = save_pars(all = TRUE),
    sample_prior = "yes",
    init = 0.1,
    file = paste0(model_path, "Model_Exp1_M3_Luce")
    ),
  name = "Model_Exp1_M3_Luce"
)

```


## 4.4 Bayes factor
```{r}

Model_M3 <- read_rds(str_glue("{model_path}Model_Exp1_M3_Softmax.rds"))

Hypothesis <- hypothesis(Model_M3, c(
  a1 = "a1_conditionkr = a1_conditioncn",
  c1 = "c1_conditionkr = c1_conditioncn",
  a2 = "a2_conditionkr = a2_conditioncn",
  c2 = "c2_conditionkr = c2_conditioncn",
  
  ra = "ra_conditionkr = ra_conditioncn",
  rc = "rc_conditionkr = rc_conditioncn"
  
))

Hypothesis$hypothesis %>% mutate(Evid.Ratio = 1/Evid.Ratio)

plot(Hypothesis)

'
Bayes factor is the column Evid.Ratio
Value larger than 1: evidence supporting a difference. 
Value smaller than 1: evidence supporting no difference.

  Hypothesis Estimate Est.Error CI.Lower CI.Upper Evid.Ratio Post.Prob Star
1         a1   -0.772     0.151   -1.073   -0.478   1.93e+06  5.17e-07    *
2         c1   -2.826     0.286   -3.390   -2.264  -7.07e+95 -1.42e-96    *
3         a2   -1.474     0.165   -1.804   -1.155  -3.22e+79 -3.11e-80    *
4         c2   -1.113     0.205   -1.515   -0.715  -1.59e+19 -6.29e-20    *
5         ra   -5.422     1.892   -9.686   -2.275   1.40e+02  7.08e-03    *
6         rc    1.522     0.826    0.231    3.492   4.05e+00  1.98e-01    *
'


```


## 4.5 Posterior

```{r}

Table_condition <- data.frame(
  condition = rep(c("cn","kr"),times = 2),
  formCond = c(
    "cn","kr",
    "Intercept","Intercept")) %>% 
  mutate(condition = factor(condition))


# Model fit
Model_M3 <- read_rds(str_glue("{model_path}Model_Exp1_M3_Softmax.rds"))

Post_M3 <- Model_M3 %>% 
  gather_draws(`b_.*`, regex = TRUE) %>% 
  separate_wider_delim(.variable, "_", names = c(NA, "par","effect"), cols_remove = TRUE) %>% 
  rename(
    condition = effect,
    post = .value) %>% 
  mutate(
    condition = str_remove(condition,"condition")
  ) %>% 
  mutate(post = case_when(
    par=="ra" ~ inv_logit_scaled(post),
    par=="rc" ~ inv_logit_scaled(post),
    TRUE ~ post
  ))


# Save the posterior
write_rds(Post_M3, str_glue("./figures/figures-Data/Post_{task}_M3.rds"))


```

## 4.6 Predicted results

### 4.6.1 Data

```{r}

Model_M3 <- read_rds(str_glue("{model_path}Model_Exp1_M3_Softmax.rds"))

Table_Res_f <- mData_M3 %>% 
  mutate(
    y = as.data.frame(y/nRet),
    itemType = ifelse(iP==0,"original","new")) %>%
  unnest_wider(y,names_sep = "") %>% 
  mutate(
    y1ori = ifelse(iP==0,y1,NA),
    y1new = ifelse(iP==1,y1,NA),
    y4 = ifelse(iP==1, y4, NA),
  ) %>% 
  select(-c(y1,iP)) %>% 
  select(participant, condition, starts_with("y")) %>% 
  pivot_longer(cols = starts_with("y"),names_to = "response",values_to = "value")

Pred_M3 <- Model_M3 %>% 
  epred_draws(
    newdata = Model_M3$data,
    ndraws = 1000
  ) %>% 
  ungroup() %>% 
  mutate(.epred = .epred/nRet) %>% 
  select(participant, condition, iP, .draw, .category, .epred) %>% 
  pivot_wider(names_from = .category, values_from = ".epred",names_prefix = "y") %>% 
  mutate(
    y1ori = ifelse(iP==0,y1,NA),
    y1new = ifelse(iP==1,y1,NA),
    y4 = ifelse(iP==1, y4, NA),
  ) %>% 
  select(-c(y1,iP)) %>% 
  pivot_longer(cols = starts_with("y"),names_to = "response", values_to = ".epred") %>% 
  summarise(.epred = mean(.epred, na.rm = T),
            .by = c(.draw, condition, response)) %>% 
  filter(
    .epred > quantile(.epred, 0.005, na.rm = T),
    .epred < quantile(.epred, 0.995, na.rm = T),
    .by = c(condition, response)
  )

```

### 4.6.2 Correct

```{r}

Table_Res_f_correct <- Table_Res_f %>% 
  filter(str_detect(response,"y1")) %>% 
  mutate(itemType = ifelse(response=="y1ori","original","new")) %>% 
  labelCondition()


Table_Pred_correct <- Pred_M3 %>% 
  filter(str_detect(response,"y1")) %>% 
  mutate(itemType = ifelse(response=="y1ori","original","new")) %>% 
  labelCondition()

Plot_Pred_correct <- Table_Res_f_correct %>% 
  summarySE(DV = value, within=c("condition","itemType"), group="participant") %>% 
  ggplot(aes(x = itemType, y = mean, color = condition))+
  geom_point()+
  geom_errorbar(aes(ymin = mean-ci, ymax = mean+ci),width = 0.05)+
  gghalves::geom_half_violin(
    data = Table_Pred_correct,
    mapping = aes(x = itemType, y = .epred, fill = condition),
    position = "identity",
    side = "r", nudge = 0.1, trim = TRUE
  )+
  labs(
    title = "Correct",
    tag = "A"
  )+
  ylim(0,1)+
  theme(
    legend.position = "inside",
    legend.justification = c(1,0),
    legend.position.inside = c(0.98,0.02),
    axis.title = element_blank(),
    axis.text = element_text(size = 10.5),
  )

```

### 4.6.3 Transposition

```{r}


Table_Res_f_trans <- Table_Res_f %>% 
  filter(str_detect(response,"y2|y3")) %>% 
  mutate(itemType = ifelse(response=="y2","original","new")) %>% 
  labelCondition()


Table_Pred_trans <- Pred_M3 %>% 
  filter(str_detect(response,"y2|y3")) %>% 
  mutate(itemType = ifelse(response=="y2","original","new")) %>% 
  labelCondition()

Plot_Pred_trans <- Table_Res_f_trans %>% 
  summarySE(DV = value, within=c("condition","itemType"), group="participant") %>% 
  ggplot(aes(x = itemType, y = mean, color = condition))+
  geom_point()+
  geom_errorbar(aes(ymin = mean-ci, ymax = mean+ci),width = 0.05)+
  gghalves::geom_half_violin(
    data = Table_Pred_trans,
    mapping = aes(x = itemType, y = .epred, fill = condition),
    position = "identity",
    side = "r", nudge = 0.1, trim = TRUE
  )+
  labs(
    title = "Transpositions",
    tag = "B"
  )+
  ylim(0,.3)+
  theme(
    axis.title = element_blank(),
    axis.text = element_text(size = 10.5),
    legend.position = "none"
  )



```

### Outdated items
```{r}

Table_Res_f_out <- Table_Res_f %>% 
  filter(str_detect(response,"y4|y5")) %>% 
  mutate(recallPos = ifelse(response=="y4","original","other")) %>% 
  labelCondition()


Table_Pred_out <- Pred_M3 %>% 
  filter(str_detect(response,"y4|y5")) %>% 
  mutate(recallPos = ifelse(response=="y4","original","other")) %>% 
  labelCondition()

Plot_Pred_out <- Table_Res_f_out %>% 
  summarySE(DV = value, within=c("condition","recallPos"), group="participant") %>% 
  ggplot(aes(x = condition, y = mean, color = condition))+
  geom_point()+
  geom_errorbar(aes(ymin = mean-ci, ymax = mean+ci),width = 0.05)+
  gghalves::geom_half_violin(
    data = Table_Pred_out,
    mapping = aes(x = condition, y = .epred, fill = condition),
    position = "identity",
    side = "r", nudge = 0.1, trim = TRUE
  )+
  facet_wrap(~ recallPos)+
  labs(
    title = "Outdated items",
    tag = "C"
  )+
  ylim(0,.3)+
  theme(
    axis.title = element_blank(),
    axis.text.x = element_blank(),
    axis.text = element_text(size = 10.5),
    legend.position = "none"
  )

```

### NPL

```{r}

Table_Res_f_NPL <- Table_Res_f %>% 
  filter(str_detect(response,"y6")) %>% 
  labelCondition()


Table_Pred_NPL <- Pred_M3 %>% 
  filter(str_detect(response,"y6")) %>% 
  labelCondition()

Plot_Pred_NPL <- Table_Res_f_NPL %>% 
  summarySE(DV = value, within=c("condition"), group="participant") %>% 
  ggplot(aes(x = condition, y = mean, color = condition))+
  geom_point()+
  geom_errorbar(aes(ymin = mean-ci, ymax = mean+ci),width = 0.05)+
  gghalves::geom_half_violin(
    data = Table_Pred_out,
    mapping = aes(x = condition, y = .epred, fill = condition),
    position = "identity",
    side = "r", nudge = 0.1, trim = TRUE
  )+
  labs(
    title = "NPL",
    tag = "D"
  )+
  ylim(0,.3)+
  theme(
    axis.title = element_blank(),
    axis.text.x = element_blank(),
    axis.text = element_text(size = 10.5),
    legend.position = "none"
  )

```

### Combined plot

```{r}

Plot_Pred_Out_NPL <- ggarrange(Plot_Pred_out,Plot_Pred_NPL,widths = c(2,1))

Plot_Pred_Error <- ggarrange(Plot_Pred_trans, Plot_Pred_Out_NPL, 
                             ncol=1)

Plot_Pred <- ggarrange(Plot_Pred_correct, Plot_Pred_Error)

ggsave(
  plot = Plot_Pred,
  path = figure_path,
  filename = "Plot_Exp1_Pred.pdf",
  width = 10, height = 6
)

```

